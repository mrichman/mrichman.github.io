	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us" prefix="og: http://ogp.me/ns#">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Rails Custom Authentication using Devise, DataMapper, and a Legacy Database - Mark Richman &amp;#x2601; Cloud Transformation Consulting</title>
  

  <meta name="author" content="Mark Richman" />
  <meta name="description" content="Mark Richman &#x2601; Cloud Transformation Consulting" />
  <meta name="keywords" content="web, performance, web, application, apm" />

  
  <link rel="author" href="https://plus.google.com/b/117121546310363840224/117121546310363840224/posts"/>
  <link rel="publisher" href="https://plus.google.com/b/117121546310363840224/117121546310363840224/posts"/>

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@mrichman">
  
  <meta name="twitter:title" content="Rails Custom Authentication using Devise, DataMapper, and a Legacy Database">
  <meta name="twitter:description" content="Rails Custom Authentication using Devise, DataMapper, and a Legacy Database">
  
  <meta name="twitter:creator" content="@mrichman">

  
  
  <meta name="og:title" content="Rails Custom Authentication using Devise, DataMapper, and a Legacy Database">
  <meta name="og:description" content="Rails Custom Authentication using Devise, DataMapper, and a Legacy Database">
  
  <meta property="og:url" content="http://markrichman.com/" />
  <meta property="og:image" content="http://markrichman.com/wp-content/uploads/2014/01/11051792_10100114777738126_1884269413074266382_n-150x150.jpg" />
  <meta property="og:site_name" content="Mark Richman | loud Transformation Consulting" />

  
  <link href="http://www.markrichman.com/index.xml" rel="alternate" type="application/rss+xml" title="Mark Richman" />

  
  
  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  
  
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <link rel="dns-prefetch" href="//fonts.gstatic.com">
  <link rel="dns-prefetch" href="//fonts.googleapis.com">
  <link rel="dns-prefetch" href="//www.googletagmanager.com">
  <link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
  <link rel="dns-prefetch" href="//www.google-analytics.com">
  <link rel="dns-prefetch" href="//ssl.google-analytics.com">
  <link rel="dns-prefetch" href="//www.facebook.com">

</head>

	<body class="">


<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NKBSZC"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NKBSZC');</script>


		<div class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
      <img src="/img/logo-mr-inverse.png" alt="Mark Richman Consulting">      
      
    </div>

    <ul class="sidebar-nav">
      
        <li><a href="/" class="sidebar-nav-item"> <i class='fa fa-home fa-fw'></i> Home </a></li>
      
        <li><a href="/about/" class="sidebar-nav-item"> <i class='fa fa-user fa-fw'></i> About </a></li>
      
        <li><a href="/services/" class="sidebar-nav-item"> <i class='fa fa-star fa-fw'></i> Services </a></li>
      
        <li><a href="/results/" class="sidebar-nav-item"> <i class='fa fa-thumbs-o-up fa-fw'></i> Results </a></li>
      
        <li><a href="/testimonials/" class="sidebar-nav-item"> <i class='fa fa-bullhorn fa-fw'></i> Testimonials </a></li>
      
        <li><a href="/clients/" class="sidebar-nav-item"> <i class='fa fa-suitcase fa-fw'></i> Clients </a></li>
      
        <li><a href="/case-studies/" class="sidebar-nav-item"> <i class='fa fa-graduation-cap fa-fw'></i> Case Studies </a></li>
      
        <li><a href="/post/" class="sidebar-nav-item"> <i class='fa fa-list fa-fw'></i> Blog </a></li>
      
        <li><a href="/publications/" class="sidebar-nav-item"> <i class='fa fa-book fa-fw'></i> Publications </a></li>
      
        <li><a href="/contact/" class="sidebar-nav-item"> <i class='fa fa-phone fa-fw'></i> Contact </a></li>
      
    </ul>

    <ul class="sidebar-nav" style="border-top:1px solid #999; padding-top:1em">
      <li>
        <a title="Email" target="_blank" href="mailto:mark@markrichman.com" class="sidebar-nav-item-inline"><i class="fa fa-envelope-o fa-fw"></i></a>
        <a title="RSS" target="_blank" href="/index.xml" class="sidebar-nav-item-inline"><i class="fa fa-rss fa-fw"></i></a>
        <a title="LinkedIn" target="_blank" href="https://www.linkedin.com/in/mrichman" class="sidebar-nav-item-inline"><i class="fa fa-linkedin fa-fw"></i></a>
        <a title="Facebook" target="_blank" href="https://www.facebook.com/markrichmanconsulting" class="sidebar-nav-item-inline"><i class="fa fa-facebook fa-fw"></i></a>
        <a title="Twitter" target="_blank" href="https://twitter.com/mrichman" class="sidebar-nav-item-inline"><i class="fa fa-twitter fa-fw"></i></a>
        <a title="Github" target="_blank" href="https://github.com/mrichman" class="sidebar-nav-item-inline"><i class="fa fa-github fa-fw"></i></a>
        <a title="StackOverflow" target="_blank" href="http://stackoverflow.com/users/134484/mark-richman" class="sidebar-nav-item-inline"><i class="fa fa-stack-overflow fa-fw"></i></a>
        <a title="Keybase" target="_blank" href="https://keybase.io/mrichman" class="sidebar-nav-item-inline"><i class="fa fa-key fa-fw"></i></a>
      </li>
    </ul>

    <p class="copyright">Copyright © 2016 Mark Richman Consulting, Inc. All rights reserved.</p>
  </div>
</div>

		  <div id="sidelinks">  
    <h4>Latest Blog Posts</h4>
    <ul>
      
        <li>
          <span><a href="http://www.markrichman.com/2016/10/25/hargo-load-testing-using-har-files-in-go/">Hargo: Load Testing using .har files in Go</a></span>
          <br/>
          <span><time class="post-list">2016-10-25</time></span>
        </li>
      
        <li>
          <span><a href="http://www.markrichman.com/web-application-performance-support-organization/">Web Application Performance and the Support Organization</a></span>
          <br/>
          <span><time class="post-list">2016-09-13</time></span>
        </li>
      
        <li>
          <span><a href="http://www.markrichman.com/reducing-infrastructure-costs-application-performance-optimization/">Reducing Infrastructure Costs through Application Performance Optimization</a></span>
          <br/>
          <span><time class="post-list">2016-09-01</time></span>
        </li>
      
        <li>
          <span><a href="http://www.markrichman.com/team-performance-self-diagnostic/">Team Performance Self-Diagnostic</a></span>
          <br/>
          <span><time class="post-list">2016-03-07</time></span>
        </li>
      
        <li>
          <span><a href="http://www.markrichman.com/rapid-innovation-self-diagnostic/">Rapid Innovation Self-Diagnostic</a></span>
          <br/>
          <span><time class="post-list">2016-02-29</time></span>
        </li>
            
    </ul>  
    <p><a href="/post/">Read more updates...</a></p>
  </div>

		<div class="content container">

			<div class="post">
			 	<h1>Rails Custom Authentication using Devise, DataMapper, and a Legacy Database</h1>
			   <span class="post-date">Mon, Nov 22, 2010</span> 
			      <p>ActiveRecord is great if your database schema evolves along with your web app from birth, but not all of us have this luxury. Many of us live in the world of corporate IT – a world of legacy databases and bureaucracies that make getting a Rails app into production hard enough, let alone getting a new schema into production. <a href="http://datamapper.org/">DataMapper</a> is a common alternative ORM to use for these scenarios. DataMapper is ideally suited for legacy databases, as <a href="http://sick.snusnu.info/">Martin Gamsjaeger</a> describes:</p>

<ul>
<li><p>DataMapper allows you to map meaningful model and property names to cryptic legacy table and column naming conventions. It allows you to do so either on a per model/property, or an app wide basis.</p></li>

<li><p>DataMapper supports lazy properties that will only be fetched when actually accessed.</p></li>

<li><p>DataMapper has seamless support for composite primary keys.</p></li>

<li><p>DataMapper only cares about the properties (columns) you explicitly declare in your models. Other columns will never be touched or read.</p></li>

<li><p>DataMapper works nicely with foreign key constraints in your database and with the help of dm-constraints it also supports creating them.</p></li>
</ul>

<p>There&#8217;s some relevant documentation on <a href="http://datamapper.org/docs/legacy">http://datamapper.org/docs/legacy</a> too.</p>

<p>I’m not going into depths with DM in this article; there are plenty of tutorials out there. What I am going to demonstrate is how to live with a legacy database written for an app with a horribly insecure authentication mechanism, based on a schema whose table and column names don’t match their Rails Model counterparts.</p>

<p>Here’s our User model:</p>

<pre>class User
  include DataMapper::Resource
  include DataMapper::MassAssignmentSecurity

  devise :database_authenticatable, :authentication_keys =&gt; [:username]
  storage_names[:default] = 'legacy_User_table'

  property :id,                 Serial,  :field =&gt; 'UserId',           :required =&gt; true
  property :username,           String,  :field =&gt; 'LoginId',          :required =&gt; true
  property :encrypted_password, String,  :field =&gt; 'PasswordSHA1Hash', :required =&gt; true
  property :enabled,            Integer, :field =&gt; 'Enabled',          :required =&gt; true
  property :is_admin,           Integer, :field =&gt; 'IsSuperAdmin',     :required =&gt; true
  property :first_name,         String,  :field =&gt; 'Name',             :required =&gt; true
  property :last_name,          String,  :field =&gt; 'Surname',          :required =&gt; true

  attr_accessible :username, :password, :password_confirmation

  def password_salt=(password_salt)
  end

  def password_salt
  end

  def password_digest(password)
    self.class.encryptor_class.digest(password)
  end

end
</pre>

<p>You’ll notice this model overrides :authentication_keys, using :username instead of :email. I also map the table name to ‘legacy_Users_table’ since we don’t have a conveniently named ‘users’ table in our schema. Our password in this monstrosity is stored as an unsalted SHA1 hash, which then gets Base64-encoded. Really secure, huh?</p>

<p>For Devise to work with unsalted passwords, I’ve had to override the password_salt functions and the password digest function that Devise looks for. Here, this lives in a custom Devise encryptor class, which I define in an initializer called devise_encryptor.rb:</p>

<pre>module Devise
  module Encryptors
    class Sha1base64 &lt; Base

      def self.digest(password)
        sha1 = Digest::SHA1.digest(password)
        Base64.strict_encode64(sha1)
      end

      def self.salt(username)
        nil
      end

    end
  end
end
</pre>

<p>This encryptor takes the password, short-circuits the salt function, and returns the Base64-encoded SHA1 hash. There are a couple of configuration changes needed to wire this up. In /initializers/devise.rb, set:</p>

<pre>config.encryptor = :sha1base64
</pre>

<p>This will reference the above custom encryptor class name.</p>

<p>There is one last workaround we have to apply to get the password_salt override in our user model to work. From the <a href="https://github.com/plataformatec/devise/blob/master/lib/devise.rb">Devise source code</a>: we have to tell Devise <strong>not</strong> to apply the schema in ORMs where the Devise declaration and schema belongs to the same class (as Datamapper and Mongoid). This goes inside devise.rb, in the Devise.config block, and is courtesy of Jared Morgan in the DataMapper mailing list:</p>

<pre>config.apply_schema = false
</pre>

<p>The last change you’ll make is in the devise sign_in view, which you likely generated using rails g devise:views. Use the :username instead of :email for your login credentials:</p>

<pre>&lt;%= f.label :username %&gt; &lt;%= f.text_field :username %&gt;</pre>

<p>If all goes well, you’ll now be able to log into your shiny new Rails app, backended by a steaming pile of crap designed and maintained by monkeys.</p>
					 
			</div>

			
				
					<h2>Comments</h2> 
				
				<div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = 'mrichman'; 

	 
    (function() {

		if (window.location.hostname == "localhost")
        	return;

        if (window.location.pathname == "/about/")
            return;

    	if (window.location.pathname == "/contact/")
        	return;

        if (window.location.pathname == "/services/")
            return;

        if (window.location.pathname == "/results/")
            return;

        if (window.location.pathname == "/testimonials/")
            return;

        if (window.location.pathname == "/clients/")
            return;

        if (window.location.pathname == "/case-studies/")
            return;

        if (window.location.pathname == "/publications/")
            return;

        if (window.location.pathname == "/post/")
            return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

			
		</div>	

  </body>
</html>
